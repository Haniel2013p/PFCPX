<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema PF - RP com Firebase</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;padding:0;background:#f0f2f5;}
  header{background:#004080;color:#fff;padding:15px;text-align:center;}
  section{max-width:700px;margin:30px auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 8px #ccc;}
  h2{color:#004080;margin-bottom:15px;}
  label{display:block;margin:8px 0 4px;}
  input, select, textarea{width:100%;padding:8px;border:1px solid #aaa;border-radius:4px;box-sizing:border-box;}
  button{margin-top:15px;padding:10px 20px;background:#004080;color:#fff;border:none;border-radius:5px;cursor:pointer;}
  button:hover{background:#003060;}
  .hidden{display:none;}
  nav{margin-bottom:20px;}
  nav button{margin-right:10px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:8px;border:1px solid #ddd;word-break:break-word;}
  th{background:#004080;color:#fff;}
  .error{color:red;margin-top:10px;}
  ul{padding-left:20px;}
  .editar, .remover{margin-left:5px;color:#004080;cursor:pointer;}
  .editar:hover, .remover:hover{color:#003060;}
</style>
</head>
<body>
<header><h1>Sistema Polícia Federal (RP)</h1></header>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<section id="dashboard-publico">
  <h2>Dashboard Público</h2>
  <button onclick="mostrarPainelPublico('painelBOPublico')">Registrar B.O Público</button>
  <button onclick="mostrarPainelPublico('painelPortariasPublicas')">Ver Portarias Públicas</button>
  <button onclick="mostrarLogin()">Iniciar Sessão</button>
  <div id="avisosPublicos" style="margin-top:20px;border:1px solid #004080;padding:10px;border-radius:5px;background:#e6f0ff;">
    <h3>Avisos Públicos</h3><ul id="listaAvisosPublicos"></ul>
  </div>
  <div id="painelBOPublico" class="hidden">
    <h3>Registrar B.O Público</h3>
    <form id="formBOPublico"><label>Título:</label><input id="tituloBOPublico" required /><label>Descrição:</label><textarea id="descricaoBOPublico" rows="4" required></textarea><label>Denunciado:</label><input id="denunciadoBOPublico" required /><button type="submit">Registrar</button></form>
    <h3>B.O.s Públicos</h3><table><thead><tr><th>Título</th><th>Descrição</th><th>Denunciado</th><th>Data</th><th>Ações</th></tr></thead><tbody id="tabelaBOPublico"></tbody></table>
  </div>
  <div id="painelPortariasPublicas" class="hidden"><h3>Portarias Públicas</h3><ul id="listaPortariasPublicas"></ul></div>
</section>

<section id="login-section" class="hidden">
  <h2>Login</h2>
  <form id="loginForm"><label>Usuário:</label><input id="username" required /><label>Senha:</label><input type="password" id="password" required /><button type="submit">Entrar</button></form>
  <div id="login-error" class="error"></div><button onclick="mostrarDashboardPublico()">Voltar</button>
</section>

<section id="app-section" class="hidden">
  <nav>
    <button onclick="mostrarPainel('painelDashboardInterno')">Dashboard Interno</button>
    <button onclick="mostrarPainel('painelBancoCriminal')">Banco Criminal</button>
    <button onclick="mostrarPainel('painelPortariasInternas')">Portarias Internas</button>
    <button onclick="mostrarPainel('painelRegistroMembros')">Registrar Membros</button>
    <button onclick="logout()">Sair</button>
  </nav>
  <div id="painelDashboardInterno" class="painel">
    <h2>Bem‑vindo, <span id="nomeLogado"></span> (<span id="cargoLogado"></span>)</h2>
    <button onclick="mostrarPainel('painelPromocoes')">Promoções / Rebaixamentos</button>
    <button onclick="mostrarPainel('painelBOPublicoInterno')">Gerenciar B.O. Público</button>
    <button onclick="mostrarPainel('painelPortariasPublicasInterno')">Gerenciar Portarias Públicas</button>
  </div>

  <!-- Promoções -->
  <div id="painelPromocoes" class="painel hidden">
    <h2>Promoções / Rebaixamentos / Exonerações</h2><table><thead><tr><th>Usuário</th><th>Cargo</th><th>Ações</th></tr></thead><tbody id="usuariosTable"></tbody></table>
  </div>

  <!-- B.O. Público Interno -->
  <div id="painelBOPublicoInterno" class="painel hidden">
    <h2>Gerenciar B.O.s Públicos</h2><table><thead><tr><th>Título</th><th>Descrição</th><th>Denunciado</th><th>Data</th><th>Ações</th></tr></thead><tbody id="tabelaBOPublicoInterno"></tbody></table>
  </div>

  <!-- Portarias Públicas Internas -->
  <div id="painelPortariasPublicasInterno" class="painel hidden">
    <h2>Gerenciar Portarias Públicas</h2><form id="formNovaPortariaPublica"><label>Título da Portaria Pública:</label><input id="tituloPortariaPublica" required /><label>Conteúdo:</label><textarea id="conteudoPortariaPublica" rows="4" required></textarea><button type="submit">Publicar</button></form>
    <ul id="listaPortariasPublicasInterno"></ul>
  </div>

  <!-- Banco Criminal -->
  <div id="painelBancoCriminal" class="painel hidden">
    <h2>Banco Criminal</h2><form id="formBancoCriminal"><label>Nome Criminoso:</label><input id="nomeCriminoso" required /><label>Tipo de Crime:</label><input id="tipoCrime" required /><label>Descrição:</label><textarea id="descricaoCrime" rows="4" required></textarea><button type="submit">Registrar Crime</button></form>
    <h3>Crimes Registrados</h3><table><thead><tr><th>Nome</th><th>Tipo</th><th>Descrição</th><th>Data</th></tr></thead><tbody id="tabelaBancoCriminal"></tbody></table>
  </div>

  <!-- Portarias Internas -->
  <div id="painelPortariasInternas" class="painel hidden">
    <h2>Portarias Internas</h2><form id="formPortariaInterna"><label>Título:</label><input id="tituloPortariaInterna" required /><label>Conteúdo:</label><textarea id="conteudoPortariaInterna" rows="4" required></textarea><button type="submit">Criar</button></form>
    <ul id="listaPortariasInternas"></ul>
  </div>

  <!-- Registro Membros -->
  <div id="painelRegistroMembros" class="painel hidden">
    <h2>Registrar Membros (Sup. Regional+)</h2><form id="formRegistroMembrosInterno"><label>Usuário:</label><input id="novoUsuario" required /><label>Senha:</label><input type="password" id="novaSenha" required /><label>Cargo:</label><select id="cargoInicial"><option disabled selected>Escolha Cargo</option><option>Agente</option><option>Perito</option><option>Escrivão</option><option>Delegado</option><option>Superintendente Regional</option><option>Diretor</option><option>Diretor Executivo</option><option>Diretor Geral</option></select><button type="submit">Cadastrar Membro</button></form>
    <h3>Membros</h3><table><thead><tr><th>Usuário</th><th>Cargo</th><th>Ações</th></tr></thead><tbody id="tabelaMembros"></tbody></table>
  </div>
</section>

<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyBuaVeRTLVxpAyboRiWS6E4KYHWlYZgMEw",
    authDomain: "pfcpx-c0b9b.firebaseapp.com",
    projectId: "pfcpx-c0b9b",
    storageBucket: "pfcpx-c0b9b",
    messagingSenderId: "322312831509",
    appId: "1:322312831509:web:e5fe68609d34db6345c41c",
    measurementId: "G-24QF5E8Q5E"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const cargosOrdem = ['Agente','Perito','Escrivão','Delegado','Superintendente Regional','Diretor','Diretor Executivo','Diretor Geral'];
  let usuarioLogado = null;

  // Inicialização
  async function inicializar(){
    await carregarAvisos();
    await garantirGabriel();
    mostrarDashboardPublico();
  }

  async function carregarAvisos(){
    const snap = await db.collection('avisosPublicos').get();
    const ul = document.getElementById('listaAvisosPublicos');
    ul.innerHTML = '';
    snap.forEach(doc => {
      const li = document.createElement('li');
      li.textContent = doc.data().texto;
      ul.appendChild(li);
    });
  }

  async function garantirGabriel(){
    const snapshot = await db.collection('usuarios').where('usuario','==','Gabriel').get();
    if (snapshot.empty){
      await db.collection('usuarios').add({usuario:'Gabriel',senha:'DG',cargo:'Diretor Geral'});
    }
  }

  // Painéis e navegação
  function mostrarDashboardPublico(){
    document.getElementById('dashboard-publico').classList.remove('hidden');
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('app-section').classList.add('hidden');
  }
  function mostrarLogin(){
    mostrarDashboardPublico();
    document.getElementById('dashboard-publico').classList.add('hidden');
    document.getElementById('login-section').classList.remove('hidden');
  }
  function mostrarPainelPublico(id){
    ['painelBOPublico','painelPortariasPublicas'].forEach(e=>document.getElementById(e).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    atualizarTabelaBOPublicoPublico();
    carregarPortariasPublicasUI();
  }

  async function mostrarPainel(id){
    if (!usuarioLogado){mostrarLogin();return;}
    document.querySelectorAll('#app-section .painel').forEach(e=>e.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if (id==='painelDashboardInterno'){
      document.getElementById('nomeLogado').textContent = usuarioLogado.usuario;
      document.getElementById('cargoLogado').textContent = usuarioLogado.cargo;
    }
    if (id==='painelPromocoes') await carregarUsuarios();
    if (id==='painelBOPublicoInterno') await carregarBOPublicoInterno();
    if (id==='painelPortariasPublicasInterno') await carregarPortariasPublicasInterno();
    if (id==='painelRegistroMembros') await carregarMembros();
    if (id==='painelPortariasInternas') await carregarPortariasInternas();
  }

  async function carregarUsuarios(){
    const snap = await db.collection('usuarios').get();
    const tbody = document.getElementById('usuariosTable'); tbody.innerHTML = '';
    snap.forEach(doc=>{
      const u = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.usuario}</td><td>${u.cargo}</td><td>${acoesUsuarioHtml(u.usuario,u.cargo,doc.id)}</td>`;
      tbody.appendChild(tr);
    });
  }
  function acoesUsuarioHtml(name,cargo,id){
    let html=''; const self = usuarioLogado.usuario;
    if(['Delegado','Superintendente Regional','Diretor','Diretor Executivo','Diretor Geral'].includes(usuarioLogado.cargo)){
      if (name!==self) {
        html+=`<button onclick="alterarCargo('${id}','promover')">Promover</button>`;
        html+=`<button onclick="alterarCargo('${id}','rebaixar')">Rebaixar</button>`;
        if (['Diretor','Diretor Executivo','Diretor Geral'].includes(usuarioLogado.cargo)){
          html+=`<button onclick="exonerar('${id}')">Exonerar</button>`;
        }
      }
    } else html='-';
    return html;
  }
  async function alterarCargo(id,acao){
    const doc = await db.collection('usuarios').doc(id).get();
    const u = doc.data(); const idx = cargosOrdem.indexOf(u.cargo);
    if (acao==='promover' && idx < cargosOrdem.length-1) {
      if (usuarioLogado.cargo==='Delegado' && cargosOrdem[idx+1]==='Diretor') return alert('Delegado não pode promover a Diretor.');
      await db.collection('usuarios').doc(id).update({cargo:cargosOrdem[idx+1]});
    }
    if (acao==='rebaixar' && idx>0) await db.collection('usuarios').doc(id).update({cargo:cargosOrdem[idx-1]});
    await carregarUsuarios();
  }
  async function exonerar(id){
    await db.collection('usuarios').doc(id).delete();
    await logAction(`Exonerado usuário ID ${id}`);
    await carregarUsuarios();
  }

  // B.O. público CRUD
  document.getElementById('formBOPublico').addEventListener('submit',async e=>{
    e.preventDefault();
    await db.collection('boPublico').add({
      titulo:document.getElementById('tituloBOPublico').value,
      descricao:document.getElementById('descricaoBOPublico').value,
      denunciado:document.getElementById('denunciadoBOPublico').value,
      data:new Date().toISOString()
    });
    e.target.reset(); await atualizarTabelaBOPublicoPublico();
  });

  async function atualizarTabelaBOPublicoPublico(){
    const tbody = document.getElementById('tabelaBOPublico'); tbody.innerHTML='';
    const snap = await db.collection('boPublico').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const bo = doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${bo.titulo}</td><td>${bo.descricao}</td><td>${bo.denunciado}</td><td>${new Date(bo.data).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function carregarBOPublicoInterno(){
    const tbody = document.getElementById('tabelaBOPublicoInterno'); tbody.innerHTML='';
    const snap = await db.collection('boPublico').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const bo=doc.data();
      const id=doc.id;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${bo.titulo}</td><td>${bo.descricao}</td><td>${bo.denunciado}</td><td>${new Date(bo.data).toLocaleString()}</td>
        <td><span class="remover" onclick="removerBOPublico('${id}')">🗑️</span></td>`;
      tbody.appendChild(tr);
    });
  }
  async function removerBOPublico(id){
    await db.collection('boPublico').doc(id).delete();
    await carregarBOPublicoInterno();
  }

  // Portarias públicas CRUD
  document.getElementById('formNovaPortariaPublica').addEventListener('submit',async e=>{
    e.preventDefault();
    await db.collection('portariasPublicas').add({
      titulo:document.getElementById('tituloPortariaPublica').value,
      conteudo:document.getElementById('conteudoPortariaPublica').value,
      data:new Date().toISOString()
    });
    e.target.reset(); await carregarPortariasPublicasInterno();
  });
  async function carregarPortariasPublicasUI(){
    const ul = document.getElementById('listaPortariasPublicas'); ul.innerHTML='';
    const snap=await db.collection('portariasPublicas').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const p=doc.data();
      const li=document.createElement('li');
      li.innerHTML=`<strong>${p.titulo}:</strong> ${p.conteudo}`;
      ul.appendChild(li);
    });
  }
  async function carregarPortariasPublicasInterno(){
    const ul = document.getElementById('listaPortariasPublicasInterno'); ul.innerHTML='';
    const snap = await db.collection('portariasPublicas').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const p=doc.data(),id=doc.id;
      const li=document.createElement('li');
      li.innerHTML=`<strong>${p.titulo}:</strong> ${p.conteudo}
        <span class="remover" onclick="removerPortariaPublica('${id}')">🗑️</span>`;
      ul.appendChild(li);
    });
  }
  async function removerPortariaPublica(id){
    await db.collection('portariasPublicas').doc(id).delete();
    await carregarPortariasPublicasInterno();
  }

  // Banco Criminal
  document.getElementById('formBancoCriminal').addEventListener('submit',async e=>{
    e.preventDefault();
    await db.collection('bancoCriminal').add({
      nome:document.getElementById('nomeCriminoso').value,
      tipo:document.getElementById('tipoCrime').value,
      descricao:document.getElementById('descricaoCrime').value,
      data:new Date().toISOString()
    });
    e.target.reset(); carregarBancoCriminal();
  });
  async function carregarBancoCriminal(){
    const tbody = document.getElementById('tabelaBancoCriminal'); tbody.innerHTML='';
    const snap=await db.collection('bancoCriminal').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const c=doc.data();
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c.nome}</td><td>${c.tipo}</td><td>${c.descricao}</td><td>${new Date(c.data).toLocaleString()}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Portarias Internas
  document.getElementById('formPortariaInterna').addEventListener('submit',async e=>{
    e.preventDefault();
    if (!['Delegado','Superintendente Regional','Diretor','Diretor Executivo','Diretor Geral'].includes(usuarioLogado.cargo)){
      return alert('Sem permissão para criar portaria interna.');
    }
    await db.collection('portariasInternas').add({
      titulo:document.getElementById('tituloPortariaInterna').value,
      conteudo:document.getElementById('conteudoPortariaInterna').value,
      data:new Date().toISOString()
    });
    e.target.reset(); carregarPortariasInternas();
  });
  async function carregarPortariasInternas(){
    const ul = document.getElementById('listaPortariasInternas'); ul.innerHTML='';
    const snap=await db.collection('portariasInternas').orderBy('data','desc').get();
    snap.forEach(doc=>{
      const p=doc.data();
      const li=document.createElement('li');
      li.innerHTML=`<strong>${p.titulo}:</strong> ${p.conteudo}`;
      ul.appendChild(li);
    });
  }

  // Registrar membros
  document.getElementById('formRegistroMembrosInterno').addEventListener('submit',async e=>{
    e.preventDefault();
    const cargo = document.getElementById('cargoInicial').value;
    if (!['Superintendente Regional','Diretor','Diretor Executivo','Diretor Geral'].includes(usuarioLogado.cargo)){
      return alert('Sem permissão para cadastrar membros.');
    }
    await db.collection('usuarios').add({
      usuario:document.getElementById('novoUsuario').value,
      senha:document.getElementById('novaSenha').value,
      cargo
    });
    e.target.reset(); await carregarMembros();
  });
  async function carregarMembros(){
    const snap=await db.collection('usuarios').get();
    const tbody=document.getElementById('tabelaMembros'); tbody.innerHTML='';
    snap.forEach(doc=>{
      const u=doc.data(),id=doc.id;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${u.usuario}</td><td>${u.cargo}</td>
        <td>${id !== usuarioLogado.id ? `<span class="remover" onclick="exonerar('${id}')">Exonerar</span>` : '-'}</td>`;
      tbody.appendChild(tr);
    });
  }

  // Login e sessão
  document.getElementById('loginForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const user=document.getElementById('username').value;
    const pass=document.getElementById('password').value;
    const snap=await db.collection('usuarios').where('usuario','==',user).where('senha','==',pass).get();
    if (!snap.empty){
      const doc = snap.docs[0]; usuarioLogado={...doc.data(), id:doc.id};
      document.getElementById('login-error').textContent='';
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('app-section').classList.remove('hidden');
      mostrarPainel('painelDashboardInterno');
    } else {
      document.getElementById('login-error').textContent='Usuário ou senha incorretos.';
    }
  });

  async function logout(){
    usuarioLogado=null;
    mostrarDashboardPublico();
  }

  // Log histórico
  async function logAction(text){
    await db.collection('log').add({texto:text,data:new Date().toISOString(),user:usuarioLogado ? usuarioLogado.usuario : 'anon'});
  }

  window.onload = inicializar;
</script>
</body>
</html>
