<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Polícia Federal do Complexo RP</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 2rem;
    background-color: #002147; /* azul escuro */
    color: white;
  }
  button {
    padding: 10px 18px;
    margin: 0 5px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
    color: white;
    font-weight: bold;
  }
  button.blue {
    background-color: #3399ff; /* azul claro */
  }
  button.admin-btn {
    background-color: #ff6600; /* laranja para botões administração */
  }
  button.delete-btn {
    background-color: #cc3300; /* vermelho para excluir */
  }
  input, textarea {
    padding: 8px;
    margin: 8px 0;
    width: 80%;
    max-width: 400px;
    border-radius: 4px;
    border: none;
  }
  .hidden {
    display: none;
  }
  #boletins-list, #usuarios-list {
    max-width: 600px;
    margin: 1rem auto;
    text-align: left;
    background-color: #004080;
    padding: 1rem;
    border-radius: 6px;
  }
  #boletins-list div, #usuarios-list div {
    border-bottom: 1px solid #336699;
    padding: 6px 0;
    color: white;
  }
  #usuarios-list div:last-child, #boletins-list div:last-child {
    border-bottom: none;
  }
  .user-action-btn {
    margin-left: 10px;
    font-size: 0.8rem;
    padding: 3px 7px;
    border-radius: 3px;
  }
  /* Novo estilo para formulário registro membro */
  #registro-membro-form {
    margin-top: 10px;
    background-color: #003366;
    padding: 15px;
    border-radius: 6px;
    max-width: 320px;
    margin-left: auto;
    margin-right: auto;
  }
  #registro-membro-form input {
    width: 90%;
  }
  #registro-membro-form button {
    margin-top: 8px;
    width: 45%;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1 id="welcome-msg">Bem vindo ao site da Polícia Federal do Complexo RP</h1>

<div id="main-buttons">
  <button id="btn-boletim" class="blue">Boletim de Ocorrência</button>
  <button id="btn-portaria" class="blue" disabled>Portarias</button>
  <button id="btn-logar" class="blue">Logar</button>
</div>

<!-- Formulário boletim -->
<div id="boletim-form" class="hidden">
  <input type="text" id="nome-denuncia" placeholder="Nome de quem denuncia" /><br />
  <input type="text" id="nome-acusado" placeholder="Nome do acusado" /><br />
  <textarea id="descricao" placeholder="Descrição"></textarea><br />
  <button class="blue" id="btn-enviar-boletim">Enviar</button>
  <button class="blue" id="btn-voltar-boletim">Voltar</button>
</div>

<!-- Formulário login -->
<div id="login-form" class="hidden">
  <input type="text" id="input-usuario" placeholder="Usuário" autocomplete="username"/><br />
  <input type="password" id="input-senha" placeholder="Senha" autocomplete="current-password"/><br />
  <button class="blue" id="btn-entrar">Entrar</button>
  <button class="blue" id="btn-voltar-login">Voltar</button>
  <p id="login-error" style="color:#ff5555;display:none;">Usuário ou senha incorretos.</p>
</div>

<!-- Após login -->
<div id="logado-area" class="hidden">
  <h2 id="msg-logado"></h2>
  <button id="btn-ver-boletins" class="blue">Ver Boletins</button>
  <button id="btn-administracao" class="admin-btn hidden">Administração</button>
  <!-- Novo botão registrar membro -->
  <button id="btn-registrar-membro" class="admin-btn hidden">Registrar Membro</button>
  <button id="btn-sair" class="blue">Sair</button>
  <div id="boletins-list" class="hidden"></div>
  <div id="usuarios-list" class="hidden"></div>

  <!-- Formulário para registrar membro novo -->
  <div id="registro-membro-form" class="hidden">
    <h3>Registrar Novo Membro</h3>
    <input type="text" id="reg-usuario" placeholder="Usuário" autocomplete="username"/><br />
    <input type="password" id="reg-senha" placeholder="Senha" autocomplete="new-password"/><br />
    <button class="blue" id="btn-registrar">Registrar</button>
    <button class="blue" id="btn-cancelar-registro">Cancelar</button>
    <p id="reg-msg" style="color:#ffdd55; display:none;"></p>
  </div>
</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBuaVeRTLVxpAyboRiWS6E4KYHWlYZgMEw",
    authDomain: "pfcpx-c0b9b.firebaseapp.com",
    projectId: "pfcpx-c0b9b",
    storageBucket: "pfcpx-c0b9b.firebasestorage.app",
    messagingSenderId: "322312831509",
    appId: "1:322312831509:web:e5fe68609d34db6345c41c",
    measurementId: "G-24QF5E8Q5E"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Hierarquia (níveis numéricos para facilitar comparações)
  const hierarquia = {
    "Agente": 1,
    "Perito": 2,
    "Escrivão": 3,
    "Delegado": 4,
    "Diretor Geral": 5
  };

  // Elementos
  const welcomeMsg = document.getElementById('welcome-msg');
  const mainButtons = document.getElementById('main-buttons');
  const btnBoletim = document.getElementById('btn-boletim');
  const btnPortaria = document.getElementById('btn-portaria');
  const btnLogar = document.getElementById('btn-logar');

  const boletimForm = document.getElementById('boletim-form');
  const nomeDenuncia = document.getElementById('nome-denuncia');
  const nomeAcusado = document.getElementById('nome-acusado');
  const descricao = document.getElementById('descricao');
  const btnEnviarBoletim = document.getElementById('btn-enviar-boletim');
  const btnVoltarBoletim = document.getElementById('btn-voltar-boletim');

  const loginForm = document.getElementById('login-form');
  const inputUsuario = document.getElementById('input-usuario');
  const inputSenha = document.getElementById('input-senha');
  const btnEntrar = document.getElementById('btn-entrar');
  const btnVoltarLogin = document.getElementById('btn-voltar-login');
  const loginError = document.getElementById('login-error');

  const logadoArea = document.getElementById('logado-area');
  const msgLogado = document.getElementById('msg-logado');
  const btnVerBoletins = document.getElementById('btn-ver-boletins');
  const btnAdministracao = document.getElementById('btn-administracao');
  const btnRegistrarMembro = document.getElementById('btn-registrar-membro');
  const btnSair = document.getElementById('btn-sair');
  const boletinsList = document.getElementById('boletins-list');
  const usuariosList = document.getElementById('usuarios-list');

  // Form registro novo membro
  const registroMembroForm = document.getElementById('registro-membro-form');
  const regUsuario = document.getElementById('reg-usuario');
  const regSenha = document.getElementById('reg-senha');
  const btnRegistrar = document.getElementById('btn-registrar');
  const btnCancelarRegistro = document.getElementById('btn-cancelar-registro');
  const regMsg = document.getElementById('reg-msg');

  // Estado login
  let usuarioLogado = null;
  let cargoLogado = null;

  // Função para garantir que o usuário Gabriel existe no Firestore ao carregar a página
  async function garantirUsuarioGabriel() {
    const userRef = db.collection('usuarios').doc('Gabriel');
    const doc = await userRef.get();
    if (!doc.exists) {
      await userRef.set({
        usuario: 'Gabriel',
        senha: 'DG',
        cargo: 'Diretor Geral'
      });
      console.log('Usuário Gabriel criado no Firestore.');
    }
  }

  // Mostrar e esconder telas
  function mostrarMain() {
    welcomeMsg.textContent = "Bem vindo ao site da Polícia Federal do Complexo RP";
    mainButtons.style.display = 'block';
    boletimForm.classList.add('hidden');
    loginForm.classList.add('hidden');
    logadoArea.classList.add('hidden');
    boletinsList.classList.add('hidden');
    usuariosList.classList.add('hidden');
    registroMembroForm.classList.add('hidden');
  }
  function mostrarBoletimForm() {
    mainButtons.style.display = 'none';
    boletimForm.classList.remove('hidden');
    nomeDenuncia.value = '';
    nomeAcusado.value = '';
    descricao.value = '';
  }
  function mostrarLoginForm() {
    mainButtons.style.display = 'none';
    loginForm.classList.remove('hidden');
    inputUsuario.value = '';
    inputSenha.value = '';
    loginError.style.display = 'none';
  }
  function mostrarLogadoArea() {
    welcomeMsg.textContent = '';
    mainButtons.style.display = 'none';
    boletimForm.classList.add('hidden');
    loginForm.classList.add('hidden');
    logadoArea.classList.remove('hidden');
    boletinsList.classList.add('hidden');
    usuariosList.classList.add('hidden');
    registroMembroForm.classList.add('hidden');
    regMsg.style.display = 'none';
    regUsuario.value = '';
    regSenha.value = '';

    msgLogado.textContent = `Bem vindo, senhor ${usuarioLogado} (${cargoLogado}).`;

   // Mostrar botão Administração e Registrar Membro só para Delegado e Diretor Geral
if (cargoLogado === 'Delegado' || cargoLogado === 'Diretor Geral') {
  btnAdministracao.classList.remove('hidden');
  btnRegistrarMembro.classList.remove('hidden');
} else {
  btnAdministracao.classList.add('hidden');
  btnRegistrarMembro.classList.add('hidden');
}

// Função para mostrar a área do usuário logado
function mostrarLogadoArea() {
  mainArea.classList.add('hidden');
  loginForm.classList.add('hidden');
  boletimForm.classList.add('hidden');
  usuarioLogadoArea.classList.remove('hidden');

  nomeUsuarioLogado.textContent = `Usuário: ${usuarioLogado} (${cargoLogado})`;

  // Mostrar ou esconder botões dependendo do cargo
  if (cargoLogado === 'Delegado' || cargoLogado === 'Diretor Geral') {
    btnAdministracao.classList.remove('hidden');
    btnRegistrarMembro.classList.remove('hidden');
  } else {
    btnAdministracao.classList.add('hidden');
    btnRegistrarMembro.classList.add('hidden');
  }
}

// Função para mostrar tela principal
function mostrarMain() {
  mainArea.classList.remove('hidden');
  loginForm.classList.add('hidden');
  boletimForm.classList.add('hidden');
  usuarioLogadoArea.classList.add('hidden');
  boletinsList.classList.add('hidden');
  usuariosList.classList.add('hidden');

  // Limpar erros de login
  loginError.style.display = 'none';
  inputUsuario.value = '';
  inputSenha.value = '';

  // Limpar formulário boletim
  nomeDenuncia.value = '';
  nomeAcusado.value = '';
  descricao.value = '';

  // Mostrar botões principais para não logados
  btnAdministracao.classList.add('hidden');
  btnRegistrarMembro.classList.add('hidden');
}

// Função para mostrar formulário de login
function mostrarLoginForm() {
  mainArea.classList.add('hidden');
  loginForm.classList.remove('hidden');
  boletimForm.classList.add('hidden');
  usuarioLogadoArea.classList.add('hidden');

  loginError.style.display = 'none';
  inputUsuario.value = '';
  inputSenha.value = '';
}

// Função para mostrar formulário boletim
function mostrarBoletimForm() {
  mainArea.classList.add('hidden');
  loginForm.classList.add('hidden');
  boletimForm.classList.remove('hidden');
  usuarioLogadoArea.classList.add('hidden');

  nomeDenuncia.value = '';
  nomeAcusado.value = '';
  descricao.value = '';
}

// Função para carregar e mostrar boletins no sistema
function carregarBoletins() {
  boletinsList.innerHTML = 'Carregando boletins...';
  boletinsList.classList.remove('hidden');

  db.collection('boletins').orderBy('data', 'desc').get()
    .then(snapshot => {
      if (snapshot.empty) {
        boletinsList.innerHTML = '<p>Nenhum boletim registrado.</p>';
        return;
      }

      let html = '<ul>';
      snapshot.forEach(doc => {
        const data = doc.data();
        const dataFormatada = data.data.toDate().toLocaleString();
        html += `<li><b>Denunciante:</b> ${data.nomeDenuncia} | <b>Acusado:</b> ${data.nomeAcusado} | <b>Descrição:</b> ${data.descricao} | <b>Data:</b> ${dataFormatada}</li>`;
      });
      html += '</ul>';
      boletinsList.innerHTML = html;
    })
    .catch(e => {
      boletinsList.innerHTML = `<p>Erro ao carregar boletins: ${e.message}</p>`;
    });
}

// Função para mostrar lista de usuários para administração
function mostrarUsuarios() {
  usuariosList.innerHTML = 'Carregando usuários...';
  usuariosList.classList.remove('hidden');

  db.collection('usuarios').get()
    .then(snapshot => {
      if (snapshot.empty) {
        usuariosList.innerHTML = '<p>Nenhum usuário cadastrado.</p>';
        return;
      }

      let html = '<ul>';
      snapshot.forEach(doc => {
        const data = doc.data();
        html += `<li><b>Usuário:</b> ${data.usuario} | <b>Cargo:</b> ${data.cargo}</li>`;
      });
      html += '</ul>';
      usuariosList.innerHTML = html;
    })
    .catch(e => {
      usuariosList.innerHTML = `<p>Erro ao carregar usuários: ${e.message}</p>`;
    });
}

// Função para garantir que exista o usuário Gabriel no banco
async function garantirUsuarioGabriel() {
  const gabrielRef = db.collection('usuarios').doc('Gabriel');
  const doc = await gabrielRef.get();
  if (!doc.exists) {
    await gabrielRef.set({
      usuario: 'Gabriel',
      senha: 'DG',
      cargo: 'Diretor Geral'
    });
  }
}

// Chamada inicial
garantirUsuarioGabriel().then(() => {
  mostrarMain();
});

