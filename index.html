<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema Polícia Federal Fictícia</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 10px;
    background: #f0f2f5;
  }
  .hidden { display: none; }
  #loginDiv, #painelPublico, #painelAdmin {
    background: white;
    border-radius: 5px;
    padding: 15px;
    box-shadow: 0 0 6px #aaa;
    max-width: 700px;
    margin: auto;
  }
  h2 {
    margin-top: 0;
    color: #004080;
  }
  input, select, textarea, button {
    padding: 6px;
    margin: 6px 0;
    width: 100%;
    box-sizing: border-box;
  }
  textarea {
    resize: vertical;
  }
  button {
    background: #004080;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background: #003060;
  }
  nav {
    margin-bottom: 10px;
  }
  nav button {
    width: auto;
    margin-right: 5px;
    padding: 8px 15px;
    border-radius: 3px;
  }
  .aba {
    border-top: 1px solid #ddd;
    margin-top: 10px;
    padding-top: 10px;
  }
  .msg {
    color: red;
    font-weight: bold;
    margin: 5px 0;
  }
  #btnAlternar {
    background: #007700;
    margin: 15px auto;
    display: block;
    width: 200px;
    font-weight: bold;
    font-size: 1rem;
  }
  #userInfo {
    text-align: right;
    margin-bottom: 15px;
    color: #004080;
  }
</style>
</head>
<body>

<button id="btnAlternar">Área Restrita</button>

<!-- Login -->
<div id="loginDiv">
  <h2>Login</h2>
  <form id="formLogin">
    <input type="text" id="loginNome" placeholder="Usuário" required />
    <input type="password" id="loginSenha" placeholder="Senha" required />
    <button type="submit">Entrar</button>
  </form>
  <div id="msgLogin" class="msg"></div>
</div>

<!-- Painel Público -->
<div id="painelPublico" class="hidden">
  <h2>Painel Público - Boletins e Portarias</h2>
  <nav>
    <button onclick="mostrarAbaPublica('bo')">Boletins de Ocorrência</button>
    <button onclick="mostrarAbaPublica('portarias')">Portarias</button>
  </nav>

  <div id="boPublico" class="aba">
    <h3>Registrar Boletim de Ocorrência (qualquer pessoa)</h3>
    <form id="formBO">
      <input type="text" id="boDenunciante" placeholder="Seu nome (denunciante)" required />
      <input type="text" id="boAcusado" placeholder="Nome do acusado" required />
      <textarea id="boRelato" placeholder="Relato do ocorrido" rows="4" required></textarea>
      <button type="submit">Registrar BO</button>
    </form>
    <div id="msgBO" class="msg"></div>
    <h4>Boletins registrados</h4>
    <div id="listaBO"></div>
  </div>

  <div id="portariasPublicas" class="aba hidden">
    <h3>Portarias</h3>
    <div id="listaPortariasPublicas"></div>
  </div>
</div>

<!-- Painel Restrito -->
<div id="painelAdmin" class="hidden">
  <div id="userInfo">
    Logado como: <span id="userNome"></span> (<span id="userCargo"></span>)
    <button onclick="logout()">Sair</button>
  </div>
  <h2>Painel Administrativo</h2>
  <nav>
    <button onclick="mostrarAbaRestrita('membros')">Membros</button>
    <button onclick="mostrarAbaRestrita('acoes')">Promoções/Rebaixamentos/Exonerações</button>
    <button onclick="mostrarAbaRestrita('criminal')">Banco Criminal</button>
    <button onclick="mostrarAbaRestrita('portarias')">Portarias</button>
  </nav>

  <div id="abaMembros" class="aba">
    <h3>Registrar Membro (Diretor Geral)</h3>
    <form id="formMembro">
      <input type="text" id="membroNome" placeholder="Nome do membro" required />
      <select id="membroCargo" required>
        <option value="" disabled selected>Escolha o cargo</option>
        <option>Agente</option>
        <option>Escrivão</option>
        <option>Delegado</option>
        <option>Superintendente Regional</option>
        <option>Diretor Geral</option>
      </select>
      <button type="submit">Registrar Membro</button>
    </form>
    <div id="msgMembro" class="msg"></div>
    <h4>Lista de membros</h4>
    <div id="listaMembros"></div>
  </div>

  <div id="abaAcoes" class="aba hidden">
    <h3>Registrar Promoção/Rebaixamento/Exoneração (Delegado+)</h3>
    <form id="formAcao">
      <input type="text" id="acaoNome" placeholder="Nome do membro" required />
      <select id="acaoTipo" required>
        <option value="" disabled selected>Tipo da ação</option>
        <option>Promoção</option>
        <option>Rebaixamento</option>
        <option>Exoneração</option>
      </select>
      <textarea id="acaoObs" placeholder="Observação" rows="3" required></textarea>
      <button type="submit">Registrar Ação</button>
    </form>
    <div id="msgAcao" class="msg"></div>
    <h4>Histórico de ações</h4>
    <div id="listaAcoes"></div>
  </div>

  <div id="abaCriminal" class="aba hidden">
    <h3>Banco Criminal (restrito)</h3>
    <form id="formCriminal">
      <input type="text" id="crimNome" placeholder="Nome do criminoso" required />
      <textarea id="crimDescricao" placeholder="Descrição do crime" rows="3" required></textarea>
      <button type="submit">Registrar Crime</button>
    </form>
    <div id="msgCrim" class="msg"></div>
    <h4>Crimes registrados</h4>
    <div id="listaCrimes"></div>
  </div>

  <div id="abaPortarias" class="aba hidden">
    <h3>Criar Portaria (Superintendente Regional+)</h3>
    <form id="formPortaria">
      <input type="text" id="portTitulo" placeholder="Título da portaria" required />
      <textarea id="portDescricao" placeholder="Descrição da portaria" rows="3" required></textarea>
      <button type="submit">Criar Portaria</button>
    </form>
    <div id="msgPortaria" class="msg"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Configuração do Firebase - substitua pelos seus dados reais!
  const firebaseConfig = {
    apiKey: "AIzaSyBuaVeRTLVxpAyboRiWS6E4KYHWlYZgMEw",
    authDomain: "pfcpx-c0b9b.firebaseapp.com",
    projectId: "pfcpx-c0b9b",
    storageBucket: "pfcpx-c0b9b.firebasestorage.app",
    messagingSenderId: "322312831509",
    appId: "1:322312831509:web:e5fe68609d34db6345c41c",
    measurementId: "G-24QF5E8Q5E"
  }; 

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Variáveis globais
<script>
  // Variáveis globais
  let usuarioAtual = null; // { nome, cargo }

  // Controle de abas público e restrito
  const loginDiv = document.getElementById('loginDiv');
  const painelPublico = document.getElementById('painelPublico');
  const painelAdmin = document.getElementById('painelAdmin');
  const btnAlternar = document.getElementById('btnAlternar');
  const userNomeSpan = document.getElementById('userNome');
  const userCargoSpan = document.getElementById('userCargo');

  // Controle abas público
  const boPublicoDiv = document.getElementById('boPublico');
  const portariasPublicasDiv = document.getElementById('portariasPublicas');

  // Controle abas restrito
  const abaMembros = document.getElementById('abaMembros');
  const abaAcoes = document.getElementById('abaAcoes');
  const abaCriminal = document.getElementById('abaCriminal');
  const abaPortarias = document.getElementById('abaPortarias');

  // Exibir área pública ou restrita conforme login
  function atualizarInterface() {
    if (usuarioAtual) {
      loginDiv.classList.add('hidden');
      painelPublico.classList.add('hidden');
      painelAdmin.classList.remove('hidden');
      userNomeSpan.textContent = usuarioAtual.nome;
      userCargoSpan.textContent = usuarioAtual.cargo;
      btnAlternar.textContent = 'Área Pública';
      mostrarAbaRestrita('membros');
    } else {
      painelAdmin.classList.add('hidden');
      loginDiv.classList.add('hidden');
      painelPublico.classList.remove('hidden');
      btnAlternar.textContent = 'Área Restrita';
      mostrarAbaPublica('bo');
    }
  }

  // Mostrar aba pública específica
  function mostrarAbaPublica(aba) {
    if (aba === 'bo') {
      boPublicoDiv.classList.remove('hidden');
      portariasPublicasDiv.classList.add('hidden');
    } else if (aba === 'portarias') {
      portariasPublicasDiv.classList.remove('hidden');
      boPublicoDiv.classList.add('hidden');
    }
  }

  // Mostrar aba restrita específica
  function mostrarAbaRestrita(aba) {
    // Esconder todas
    abaMembros.classList.add('hidden');
    abaAcoes.classList.add('hidden');
    abaCriminal.classList.add('hidden');
    abaPortarias.classList.add('hidden');

    switch (aba) {
      case 'membros': abaMembros.classList.remove('hidden'); break;
      case 'acoes': abaAcoes.classList.remove('hidden'); break;
      case 'criminal': abaCriminal.classList.remove('hidden'); break;
      case 'portarias': abaPortarias.classList.remove('hidden'); break;
    }
  }

  // Função para validar login
  function validarLogin(nome, senha) {
    // Usuário fixo Gabriel, senha DG, cargo Diretor Geral
    if (nome.trim().toLowerCase() === 'gabriel' && senha === 'DG') {
      return { nome: 'Gabriel', cargo: 'Diretor Geral' };
    }
    return null;
  }

  // Salvar usuário atual no localStorage para manter login
  function salvarSessao() {
    if (usuarioAtual) {
      localStorage.setItem('pf_usuario', JSON.stringify(usuarioAtual));
    } else {
      localStorage.removeItem('pf_usuario');
    }
  }

  // Recuperar usuário atual do localStorage
  function carregarSessao() {
    const user = localStorage.getItem('pf_usuario');
    if (user) {
      try {
        usuarioAtual = JSON.parse(user);
      } catch {
        usuarioAtual = null;
      }
    }
  }

  // Logout
  function logout() {
    usuarioAtual = null;
    salvarSessao();
    atualizarInterface();
  }

  // Botão alternar público/restrito
  btnAlternar.onclick = () => {
    if (!usuarioAtual) {
      // não logado, leva ao login
      painelPublico.classList.add('hidden');
      painelAdmin.classList.add('hidden');
      loginDiv.classList.remove('hidden');
      btnAlternar.textContent = 'Área Restrita';
    } else {
      // alterna entre público e restrito
      if (!painelAdmin.classList.contains('hidden')) {
        // está na área restrita, vai para pública
        painelAdmin.classList.add('hidden');
        painelPublico.classList.remove('hidden');
        btnAlternar.textContent = 'Área Restrita';
      } else {
        // está na área pública, vai para restrita
        painelPublico.classList.add('hidden');
        painelAdmin.classList.remove('hidden');
        btnAlternar.textContent = 'Área Pública';
        userNomeSpan.textContent = usuarioAtual.nome;
        userCargoSpan.textContent = usuarioAtual.cargo;
      }
    }
    loginDiv.classList.add('hidden');
  };

  // =====================
  // FUNÇÕES FIREBASE
  // =====================

  // Pega dados Firebase uma única vez, resolve promise
  function lerDados(path) {
    return db.ref(path).get().then(snapshot => snapshot.exists() ? snapshot.val() : null);
  }

  // Grava dados Firebase
  function gravarDados(path, dados) {
    return db.ref(path).set(dados);
  }

  // Atualiza parte dos dados (merge)
  function atualizarDados(path, dados) {
    return db.ref(path).update(dados);
  }

  // Adiciona item novo (gera chave única)
  function adicionarItem(path, item) {
    const novaRef = db.ref(path).push();
    return novaRef.set(item).then(() => novaRef.key);
  }

  // =====================
  // BOLETINS DE OCORRÊNCIA - PÚBLICO
  // =====================

  const formBO = document.getElementById('formBO');
  const msgBO = document.getElementById('msgBO');
  const listaBO = document.getElementById('listaBO');

  formBO.addEventListener('submit', async e => {
    e.preventDefault();
    msgBO.textContent = '';
    const denunciante = formBO.boDenunciante.value.trim();
    const acusado = formBO.boAcusado.value.trim();
    const relato = formBO.boRelato.value.trim();
    if (!denunciante || !acusado || !relato) {
      msgBO.textContent = 'Preencha todos os campos.';
      return;
    }
    const novoBO = {
      denunciante,
      acusado,
      relato,
      data: new Date().toISOString()
    };
    try {
      await adicionarItem('boletins', novoBO);
      msgBO.style.color = 'green';
      msgBO.textContent = 'BO registrado com sucesso!';
      formBO.reset();
      carregarBoletins();
    } catch (err) {
      msgBO.style.color = 'red';
      msgBO.textContent = 'Erro ao registrar BO.';
    }
  });

  async function carregarBoletins() {
    listaBO.innerHTML = 'Carregando...';
    const dados = await lerDados('boletins');
    if (!dados) {
      listaBO.innerHTML = '<p>Nenhum boletim registrado.</p>';
      return;
    }
    const keys = Object.keys(dados).sort((a,b) => dados[b].data.localeCompare(dados[a].data));
    const html = keys.map(k => {
      const bo = dados[k];
      return `<div style="border-bottom:1px solid #ccc; padding:5px 0;">
        <b>Denunciante:</b> ${escapeHtml(bo.denunciante)}<br>
        <b>Acusado:</b> ${escapeHtml(bo.acusado)}<br>
        <b>Relato:</b> ${escapeHtml(bo.relato)}<br>
        <small><i>Data: ${new Date(bo.data).toLocaleString()}</i></small>
      </div>`;
    }).join('');
    listaBO.innerHTML = html;
  }

  // =====================
  // PORTARIAS
  // =====================

  const formPortaria = document.getElementById('formPortaria');
  const msgPortaria = document.getElementById('msgPortaria');
  const listaPortariasPublicas = document.getElementById('listaPortariasPublicas');

  formPortaria.addEventListener('submit', async e => {
    e.preventDefault();
    msgPortaria.textContent = '';

    if (!permissaoPortaria()) {
      msgPortaria.style.color = 'red';
      msgPortaria.textContent = 'Você não tem permissão para criar portarias.';
      return;
    }

    const titulo = formPortaria.portTitulo.value.trim();
    const descricao = formPortaria.portDescricao.value.trim();
    if (!titulo || !descricao) {
      msgPortaria.textContent = 'Preencha todos os campos.';
      return;
    }

    const novaPortaria = {
      titulo,
      descricao,
      data: new Date().toISOString(),
      autor: usuarioAtual.nome
    };

    try {
      await adicionarItem('portarias', novaPortaria);
      msgPortaria.style.color = 'green';
      msgPortaria.textContent = 'Portaria criada com sucesso!';
      formPortaria.reset();
      carregarPortarias();
    } catch {
      msgPortaria.style.color = 'red';
      msgPortaria.textContent = 'Erro ao criar portaria.';
    }
  });

  async function carregarPortarias() {
    listaPortariasPublicas.innerHTML = 'Carregando...';
    const dados = await lerDados('portarias');
    if (!dados) {
      listaPortariasPublicas.innerHTML = '<p>Nenhuma portaria registrada.</p>';
      return;
    }
    const keys = Object.keys(dados).sort((a,b) => dados[b].data.localeCompare(dados[a].data));
    const html = keys.map(k => {
      const p = dados[k];
      return `<div style="border-bottom:1px solid #ccc; padding:5px 0;">
        <b>${escapeHtml(p.titulo)}</b><br>
        ${escapeHtml(p.descricao).replace(/\n/g,'<br>')}<br>
        <small><i>Criada por: ${escapeHtml(p.autor)} em ${new Date(p.data).toLocaleString()}</i></small>
      </div>`;
    }).join('');
    listaPortariasPublicas.innerHTML = html;
  }

  // =====================
  // MEMBROS (Diretor Geral)
  // =====================

  const formMembro = document.getElementById('formMembro');
  const msgMembro = document.getElementById('msgMembro');
  const listaMembros = document.getElementById('listaMembros');

  formMembro.addEventListener('submit', async e => {
    e.preventDefault();
    msgMembro.textContent = '';

    if (!usuarioAtual || usuarioAtual.cargo !== 'Diretor Geral') {
      msgMembro.style.color = 'red';
      msgMembro.textContent = 'Apenas Diretor Geral pode registrar membros.';
      return;
    }

    const nome = formMembro.membroNome.value.trim();
    const cargo = formMembro.membroCargo.value;
    if (!nome || !cargo) {
      msgMembro.textContent = 'Preencha todos os campos.';
      return;
    }

    const novoMembro = { nome, cargo };
    try {
      await adicionarItem('membros', novoMembro);
      msgMembro.style.color = 'green';
      msgMembro.textContent = 'Membro registrado com sucesso!';
      formMembro.reset();
      carregarMembros();
    } catch {
      msgMembro.style.color = 'red';
      msgMembro.textContent = 'Erro ao registrar membro.';
    }
  });

  async function carregarMembros() {
    listaMembros.innerHTML = 'Carregando...';
    const dados = await lerDados('membros');
    if (!dados) {
      listaMembros.innerHTML = '<p>Nenhum membro registrado.</p>';
      return;
    }
    const keys = Object.keys(dados);
    const html = keys.map(k => {
      const m = dados[k];
      return `<div style="border-bottom:1px solid #ccc; padding:4px 0;">
        <b>${escapeHtml(m.nome)}</b> - ${escapeHtml(m.cargo)}
      </div>`;
    }).join('');
    listaMembros.innerHTML = html;
  }

  // =====================
  // PROMOÇÕES, REBAIXAMENTOS, EXONERAÇÕES (Delegado+)
  // =====================

  const formAcao = document.getElementById('formAcao');
  const msgAcao = document.getElementById('msgAcao');
  const listaAcoes = document.getElementById('listaAcoes');

  // Hierarquia para controle simples
  const cargosHierarquia = [
    'Agente',
    'Escrivão',
    'Delegado',
    'Superintendente Regional',
    'Diretor Geral'
  ];

  function cargoNivel(cargo) {
    return cargosHierarquia.indexOf(cargo);
  }

  // Verifica se usuário atual tem permissão Delegado ou superior
  function permissaoDelegadoPlus() {
    if (!usuarioAtual) return false;
    return cargoNivel(usuarioAtual.cargo) >= cargoNivel('Delegado');
  }

  formAcao.addEventListener('submit', async e => {
    e.preventDefault();
    msgAcao.textContent = '';

    if (!permissaoDelegadoPlus()) {
      msgAcao.style.color = 'red';
      msgAcao.textContent = 'Apenas Delegado ou superior pode registrar ações.';
      return;
    }

    const nome = formAcao.acaoNome.value.trim();
    const tipo = formAcao.acaoTipo.value;
    const obs = formAcao.acaoObs.value.trim();
    if (!nome || !tipo || !obs) {
      msgAcao.textContent = 'Preencha todos os campos.';
      return;
    }

    // Verificar se membro existe para validar permissões e evitar ações inválidas
    const membros = await lerDados('membros') || {};
    const membroEncontrado = Object.values(membros).find(m => m.nome.toLowerCase() === nome.toLowerCase());
    if (!membroEncontrado) {
      msgAcao.style.color = 'red';
      msgAcao.textContent = 'Membro não encontrado para realizar a ação.';
      return;
    }

    // Regras:
    // - Apenas Delegado+ pode promover/rebaixar/exonerar
    // - Diretor Geral pode tudo
    // - Além disso, só pode promover se cargo do operador > cargo do membro
    if (cargoNivel(usuarioAtual.cargo) <= cargoNivel(membroEncontrado.cargo) && usuarioAtual.cargo !== 'Diretor Geral') {
      msgAcao.style.color = 'red';
      msgAcao.textContent = 'Você não pode agir sobre um membro com cargo igual ou superior.';
      return;
    }

    // Ao promover/rebaixar, atualizar cargo do membro conforme regra simples
    let novoCargo = membroEncontrado.cargo;
    if (tipo === 'Promoção') {
      const nivelAtual = cargoNivel(membroEncontrado.cargo);
      if (nivelAtual === cargosHierarquia.length - 1) {
        msgAcao.style.color = 'red';
        msgAcao.textContent = 'Membro já está no cargo máximo.';
        return;
      }
      novoCargo = cargosHierarquia[nivelAtual + 1];
    } else if (tipo === 'Rebaixamento') {
      const nivelAtual = cargoNivel(membroEncontrado.cargo);
      if (nivelAtual === 0) {
        msgAcao.style.color = 'red';
        msgAcao.textContent = 'Membro já está no cargo mínimo.';
        return;
      }
      novoCargo = cargosHierarquia[nivelAtual - 1];
    } else if (tipo === 'Exoneração') {
      novoCargo = 'Exonerado';
    }

    const novaAcao = {
      nome,
      tipo,
      obs,
      data: new Date().toISOString(),
      operador: usuarioAtual.nome,
      novoCargo
    };

    try {
      // Adicionar ação
      await adicionarItem('acoes', novaAcao);
      // Atualizar cargo do membro no banco
      // Procurar a chave do membro para atualizar
      const membroKey = Object.entries(membros).find(([k,v]) => v.nome.toLowerCase() === nome.toLowerCase())?.[0];
      if (membroKey) {
        await atualizarDados(`membros/${membroKey}`, { cargo: novoCargo });
      }
      msgAcao.style.color = 'green';
      msgAcao.textContent = 'Ação registrada com sucesso!';
      formAcao.reset();
      carregarAcoes();
      carregarMembros();
    } catch {
      msgAcao.style.color = 'red';
      msgAcao.textContent = 'Erro ao registrar ação.';
    }
  });

  async function carregarAcoes() {
    listaAcoes.innerHTML = 'Carregando...';
    const dados = await lerDados('acoes');
    if (!dados) {
      listaAcoes.innerHTML = '<p>Nenhuma ação registrada.</p>';
      return;
    }
    const keys = Object.keys(dados).sort((a,b) => dados[b].data.localeCompare(dados[a].data));
    const html = keys.map(k => {
      const a = dados[k];
      return `<div style="border-bottom:1px solid #ccc; padding:5px 0;">
        <b>${escapeHtml(a.tipo)}</b> em <b>${escapeHtml(a.nome)}</b><br>
        <b>Operador:</b> ${escapeHtml(a.operador)}<br>
        <b>Observação:</b> ${escapeHtml(a.obs).replace(/\n/g, '<br>')}<br>
        <b>Novo Cargo:</b> ${escapeHtml(a.novoCargo)}<br>
        <small><i>Data: ${new Date(a.data).toLocaleString()}</i></small>
      </div>`;
    }).join('');
    listaAcoes.innerHTML = html;
  }

  // =====================
  // BANCO CRIMINAL (restrito)
  // =====================

  const formCriminal = document.getElementById('formCriminal');
  const msgCrim = document.getElementById('msgCrim');
  const listaCrimes = document.getElementById('listaCrimes');

  formCriminal.addEventListener('submit', async e => {
    e.preventDefault();
    msgCrim.textContent = '';

    if (!usuarioAtual) {
      msgCrim.style.color =     'red';
    msgCrim.textContent = 'Você precisa estar logado para registrar crimes.';
    return;
  }

  const nome = formCriminal.crimNome.value.trim();
  const tipoCrime = formCriminal.crimTipo.value.trim();
  const obs = formCriminal.crimObs.value.trim();

  if (!nome || !tipoCrime || !obs) {
    msgCrim.textContent = 'Preencha todos os campos.';
    return;
  }

  const novoCrime = {
    nome,
    tipoCrime,
    obs,
    data: new Date().toISOString(),
    autor: usuarioAtual.nome
  };

  try {
    await adicionarItem('bancoCriminal', novoCrime);
    msgCrim.style.color = 'green';
    msgCrim.textContent = 'Crime registrado com sucesso!';
    formCriminal.reset();
    carregarCrimes();
  } catch {
    msgCrim.style.color = 'red';
    msgCrim.textContent = 'Erro ao registrar crime.';
  }
});

async function carregarCrimes() {
  listaCrimes.innerHTML = 'Carregando...';
  const dados = await lerDados('bancoCriminal');
  if (!dados) {
    listaCrimes.innerHTML = '<p>Nenhum registro criminal.</p>';
    return;
  }
  const keys = Object.keys(dados).sort((a,b) => dados[b].data.localeCompare(dados[a].data));
  const html = keys.map(k => {
    const c = dados[k];
    return `<div style="border-bottom:1px solid #ccc; padding:5px 0;">
      <b>${escapeHtml(c.tipoCrime)}</b> - <b>${escapeHtml(c.nome)}</b><br>
      <b>Observação:</b> ${escapeHtml(c.obs).replace(/\n/g,'<br>')}<br>
      <small><i>Registrado por ${escapeHtml(c.autor)} em ${new Date(c.data).toLocaleString()}</i></small>
    </div>`;
  }).join('');
  listaCrimes.innerHTML = html;
}

// =====================
// Permissões específicas
// =====================

function permissaoPortaria() {
  if (!usuarioAtual) return false;
  const nivel = cargoNivel(usuarioAtual.cargo);
  // Superintendente Regional (index 3) ou superior (Diretor Geral = 4)
  return nivel >= cargoNivel('Superintendente Regional');
}

// =====================
// Escape para segurança XSS
// =====================
function escapeHtml(text) {
  if (!text) return '';
  return text.replace(/[&<>"']/g, function(m) {
    switch (m) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return m;
    }
  });
}

// =====================
// Eventos dos menus público
// =====================
document.getElementById('menuPublicoBo').onclick = () => mostrarAbaPublica('bo');
document.getElementById('menuPublicoPortarias').onclick = () => mostrarAbaPublica('portarias');

// =====================
// Eventos dos menus restrito
// =====================
document.getElementById('menuMembros').onclick = () => mostrarAbaRestrita('membros');
document.getElementById('menuAcoes').onclick = () => mostrarAbaRestrita('acoes');
document.getElementById('menuCriminal').onclick = () => mostrarAbaRestrita('criminal');
document.getElementById('menuPortarias').onclick = () => mostrarAbaRestrita('portarias');

// =====================
// Login e logout
// =====================

const formLogin = document.getElementById('formLogin');
const msgLogin = document.getElementById('msgLogin');

formLogin.addEventListener('submit', e => {
  e.preventDefault();
  msgLogin.textContent = '';
  const nome = formLogin.loginNome.value.trim();
  const senha = formLogin.loginSenha.value;

  const usuario = validarLogin(nome, senha);
  if (usuario) {
    usuarioAtual = usuario;
    salvarSessao();
    atualizarInterface();
    formLogin.reset();
  } else {
    msgLogin.style.color = 'red';
    msgLogin.textContent = 'Usuário ou senha inválidos.';
  }
});

document.getElementById('btnLogout').onclick = () => {
  logout();
};

// =====================
// Inicialização
// =====================

async function inicializar() {
  carregarSessao();
  atualizarInterface();
  carregarBoletins();
  carregarPortarias();
  carregarMembros();
  carregarAcoes();
  carregarCrimes();
}

inicializar();

</script>

</body>
</html>

