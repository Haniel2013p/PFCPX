<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Polícia Federal Complexo RP</title>
  <style>
    body {
      background-color: #001f3f; /* azul escuro */
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1, h2, h3 {
      font-weight: normal;
      text-align: center;
    }
    .container {
      width: 100%;
      max-width: 600px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .hidden {
      display: none;
    }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      background-color: #0074D9;
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #005fa3;
    }
    input, textarea {
      display: block;
      margin: 8px auto;
      padding: 8px;
      border-radius: 5px;
      border: none;
      width: 100%;
      max-width: 400px;
      font-size: 16px;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    .error-msg, .success-msg {
      width: 100%;
      max-width: 400px;
      text-align: center;
      margin-top: 5px;
      font-weight: bold;
    }
    .error-msg { color: #ff6b6b; }
    .success-msg { color: #2ecc71; }
    .btn-danger { background-color: #ff4136; }
    .btn-danger:hover { background-color: #cc342a; }
    .btn-admin { background-color: #39CCCC; }
    .btn-admin:hover { background-color: #2a9a9a; }
    .list-item {
      background-color: #003366;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 5px;
      width: 100%;
      max-width: 400px;
    }
    .list-item strong { font-weight: bold; }
    .user-actions { display: flex; justify-content: center; gap: 8px; margin-top: 5px; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <h1 id="welcome-title">Bem vindo ao site da Polícia Federal do Complexo RP</h1>

  <div class="container">

    <!-- Área principal -->
    <div id="main-menu" class="btn-group">
      <button id="btn-open-boletim">Registrar Boletim</button>
      <button id="btn-open-portaria">Portarias</button>
      <button id="btn-open-login">Login</button>
    </div>

    <!-- Registrar Boletim -->
    <div id="form-boletim" class="hidden container">
      <h2>Registrar Boletim</h2>
      <input id="input-denuncia" placeholder="Nome da denúncia" maxlength="50" />
      <input id="input-acusado" placeholder="Nome do acusado" maxlength="50" />
      <textarea id="input-descricao" placeholder="Descrição detalhada" maxlength="500"></textarea>
      <div class="btn-group">
        <button id="btn-submit-boletim">Enviar Boletim</button>
        <button id="btn-cancel-boletim" class="btn-danger">Cancelar</button>
      </div>
      <div id="msg-boletim" class="error-msg hidden"></div>
    </div>

    <!-- Portarias -->
    <div id="area-portarias" class="hidden container">
      <h2>Portarias</h2>
      <p>Aqui estarão as portarias publicadas.</p>
      <button id="btn-back-portarias" class="btn-danger">Voltar</button>
    </div>

    <!-- Login -->
    <div id="form-login" class="hidden container">
      <h2>Login</h2>
      <input id="input-username" placeholder="Usuário" maxlength="30" />
      <input id="input-password" type="password" placeholder="Senha" maxlength="30" />
      <div class="btn-group">
        <button id="btn-submit-login">Entrar</button>
        <button id="btn-cancel-login" class="btn-danger">Cancelar</button>
      </div>
      <div id="msg-login-error" class="error-msg hidden"></div>
    </div>

    <!-- Área logado -->
    <div id="area-logado" class="hidden container">
      <div id="welcome-user" style="margin-bottom:16px; text-align:center;"></div>
      <div class="btn-group">
        <button id="btn-view-boletins">Ver Boletins</button>
        <button id="btn-admin" class="btn-admin hidden">Administração</button>
        <button id="btn-register-member" class="btn-admin hidden">Registrar Membro</button>
        <button id="btn-logout" class="btn-danger">Sair</button>
      </div>
    </div>

    <!-- Lista de boletins -->
    <div id="lista-boletins" class="hidden container">
      <h3>Boletins Registrados</h3>
      <div id="boletins-container"></div>
      <button id="btn-back-boletins" class="btn-danger">Voltar</button>
    </div>

    <!-- Lista de usuários -->
    <div id="lista-usuarios" class="hidden container">
      <h3>Gerenciar Usuários</h3>
      <div id="usuarios-container"></div>
      <button id="btn-back-usuarios" class="btn-danger">Voltar</button>
    </div>

    <!-- Registrar membro -->
    <div id="form-register-member" class="hidden container">
      <h2>Registrar Novo Membro</h2>
      <input id="input-new-username" placeholder="Novo Usuário" maxlength="30" />
      <input id="input-new-password" type="password" placeholder="Senha" maxlength="30" />
      <div class="btn-group">
        <button id="btn-submit-register-member">Registrar</button>
        <button id="btn-cancel-register-member" class="btn-danger">Cancelar</button>
      </div>
      <div id="msg-register-member" class="error-msg hidden"></div>
    </div>

  </div> <!-- fim container -->

  <script>
    // Firebase config original
    const firebaseConfig = {
      apiKey: "AIzaSyBuaVeRTLVxpAyboRiWS6E4KYHWlYZgMEw",
      authDomain: "pfcpx-c0b9b.firebaseapp.com",
      projectId: "pfcpx-c0b9b",
      storageBucket: "pfcpx-c0b9b.firebasestorage.app",
      messagingSenderId: "322312831509",
      appId: "1:322312831509:web:e5fe68609d34db6345c41c",
      measurementId: "G-24QF5E8Q5E"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Hierarquia para cargos
    const hierarquia = {
      "Agente":1,
      "Perito":2,
      "Escrivão":3,
      "Delegado":4,
      "Diretor Geral":5
    };

    let usuarioLogado = null;
    let cargoLogado = null;

    // Função para mostrar e esconder elementos
    function mostrar(id) {
      document.getElementById(id).classList.remove('hidden');
    }
    function esconder(id) {
      document.getElementById(id).classList.add('hidden');
    }
    function esconderTodos() {
      ['main-menu','form-boletim','area-portarias','form-login','area-logado','lista-boletins','lista-usuarios','form-register-member'].forEach(id => esconder(id));
      clearMessages();
    }

    function clearMessages() {
      ['msg-boletim','msg-login-error','msg-register-member'].forEach(id => {
        const el = document.getElementById(id);
        if(el) {
          el.classList.add('hidden');
          el.textContent = '';
        }
      });
    }

    // Inicializar app, garantindo usuário Gabriel exista
    async function init() {
      const gabrielRef = db.collection('usuarios').doc('Gabriel');
      const doc = await gabrielRef.get();
      if(!doc.exists) {
        await gabrielRef.set({
          usuario: 'Gabriel',
          senha: 'DG',
          cargo: 'Diretor Geral'
        });
      }
    }
    init();

    // Mostrar menu principal
    function mostrarMenuPrincipal() {
  esconderTodos();
  mostrar('main-menu');
  document.getElementById('welcome-title').textContent = "Bem vindo ao site da Polícia Federal do Complexo RP";
  usuarioLogado = null;
  cargoLogado = null;
}

// Mostrar formulário para registrar boletim
function mostrarFormBoletim() {
  esconderTodos();
  mostrar('form-boletim');
  clearMessages();
  document.getElementById('input-denuncia').value = '';
  document.getElementById('input-acusado').value = '';
  document.getElementById('input-descricao').value = '';
}

// Mostrar área de portarias
function mostrarPortarias() {
  esconderTodos();
  mostrar('area-portarias');
}

// Mostrar formulário de login
function mostrarFormLogin() {
  esconderTodos();
  mostrar('form-login');
  clearMessages();
  document.getElementById('input-username').value = '';
  document.getElementById('input-password').value = '';
}

// Mostrar área para usuário logado
function mostrarAreaLogado() {
  esconderTodos();
  mostrar('area-logado');
  document.getElementById('welcome-user').textContent = `Olá, ${usuarioLogado} (${cargoLogado})`;

  // Mostrar botões admin se cargo for alto
  if (hierarquia[cargoLogado] >= hierarquia['Delegado']) {
    document.getElementById('btn-admin').classList.remove('hidden');
    document.getElementById('btn-register-member').classList.remove('hidden');
  } else {
    document.getElementById('btn-admin').classList.add('hidden');
    document.getElementById('btn-register-member').classList.add('hidden');
  }
}

// Enviar boletim para o Firestore
async function enviarBoletim() {
  clearMessages();
  const denuncia = document.getElementById('input-denuncia').value.trim();
  const acusado = document.getElementById('input-acusado').value.trim();
  const descricao = document.getElementById('input-descricao').value.trim();

  if (!denuncia || !acusado || !descricao) {
    const msg = document.getElementById('msg-boletim');
    msg.textContent = "Preencha todos os campos.";
    msg.classList.remove('hidden');
    return;
  }

  try {
    await db.collection('boletins').add({
      denuncia,
      acusado,
      descricao,
      data: new Date(),
      autor: usuarioLogado || 'Visitante'
    });
    const msg = document.getElementById('msg-boletim');
    msg.textContent = "Boletim registrado com sucesso!";
    msg.classList.remove('hidden');
    msg.classList.remove('error-msg');
    msg.classList.add('success-msg');

    // Limpar campos após sucesso
    document.getElementById('input-denuncia').value = '';
    document.getElementById('input-acusado').value = '';
    document.getElementById('input-descricao').value = '';
  } catch (error) {
    const msg = document.getElementById('msg-boletim');
    msg.textContent = "Erro ao registrar boletim: " + error.message;
    msg.classList.remove('hidden');
  }
}

// Realizar login
async function login() {
  clearMessages();
  const username = document.getElementById('input-username').value.trim();
  const password = document.getElementById('input-password').value.trim();

  if (!username || !password) {
    const msg = document.getElementById('msg-login-error');
    msg.textContent = "Informe usuário e senha.";
    msg.classList.remove('hidden');
    return;
  }

  try {
    const userDoc = await db.collection('usuarios').doc(username).get();
    if (!userDoc.exists) {
      throw new Error("Usuário não encontrado.");
    }
    const data = userDoc.data();
    if (data.senha !== password) {
      throw new Error("Senha incorreta.");
    }

    usuarioLogado = username;
    cargoLogado = data.cargo;

    mostrarAreaLogado();
  } catch (error) {
    const msg = document.getElementById('msg-login-error');
    msg.textContent = error.message;
    msg.classList.remove('hidden');
  }
}

// Logout
function logout() {
  usuarioLogado = null;
  cargoLogado = null;
  mostrarMenuPrincipal();
}

// Mostrar lista de boletins
async function mostrarBoletins() {
  esconderTodos();
  mostrar('lista-boletins');

  const container = document.getElementById('boletins-container');
  container.innerHTML = 'Carregando...';

  try {
    const snapshot = await db.collection('boletins').orderBy('data', 'desc').get();
    if (snapshot.empty) {
      container.innerHTML = '<p>Nenhum boletim registrado.</p>';
      return;
    }
    container.innerHTML = '';
    snapshot.forEach(doc => {
      const b = doc.data();
      const dataFormatada = b.data.toDate().toLocaleString('pt-BR');
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>Denúncia:</strong> ${b.denuncia} <br/>
        <strong>Acusado:</strong> ${b.acusado} <br/>
        <strong>Descrição:</strong> ${b.descricao} <br/>
        <strong>Data:</strong> ${dataFormatada} <br/>
        <strong>Autor:</strong> ${b.autor}
      `;
      container.appendChild(div);
    });
  } catch (error) {
    container.innerHTML = `<p>Erro ao carregar boletins: ${error.message}</p>`;
  }
}

// Mostrar lista de usuários para administração
async function mostrarUsuarios() {
  esconderTodos();
  mostrar('lista-usuarios');

  const container = document.getElementById('usuarios-container');
  container.innerHTML = 'Carregando...';

  try {
    const snapshot = await db.collection('usuarios').get();
    container.innerHTML = '';
    snapshot.forEach(doc => {
      const u = doc.data();
      const div = document.createElement('div');
      div.className = 'list-item';
      div.innerHTML = `
        <strong>${u.usuario}</strong> - ${u.cargo}
        <div class="user-actions">
          <button class="btn-admin" onclick="promoverUsuario('${u.usuario}')">Promover</button>
          <button class="btn-admin" onclick="rebaixarUsuario('${u.usuario}')">Rebaixar</button>
          <button class="btn-danger" onclick="removerUsuario('${u.usuario}')">Remover</button>
        </div>
      `;
      container.appendChild(div);
    });
  } catch (error) {
    container.innerHTML = `<p>Erro ao carregar usuários: ${error.message}</p>`;
  }
}

// Promover usuário
async function promoverUsuario(usuario) {
  if (!confirm(`Deseja realmente promover ${usuario}?`)) return;

  const userRef = db.collection('usuarios').doc(usuario);
  const doc = await userRef.get();
  if (!doc.exists) return alert('Usuário não encontrado.');

  const cargoAtual = doc.data().cargo;
  const nivelAtual = hierarquia[cargoAtual];
  if (nivelAtual >= Object.values(hierarquia).reduce((a,b) => Math.max(a,b))) {
    return alert('Usuário já está no cargo máximo.');
  }

  const cargos = Object.keys(hierarquia);
  const novoCargo = cargos.find(c => hierarquia[c] === nivelAtual + 1);

  await userRef.update({ cargo: novoCargo });
  alert(`${usuario} promovido a ${novoCargo}.`);
  mostrarUsuarios();
}

// Rebaixar usuário
async function rebaixarUsuario(usuario) {
  if (!confirm(`Deseja realmente rebaixar ${usuario}?`)) return;

  const userRef = db.collection('usuarios').doc(usuario);
  const doc = await userRef.get();
  if (!doc.exists) return alert('Usuário não encontrado.');

  const cargoAtual = doc.data().cargo;
  const nivelAtual = hierarquia[cargoAtual];
  if (nivelAtual <= 1) {
    return alert('Usuário já está no cargo mínimo.');
  }

  const cargos = Object.keys(hierarquia);
  const novoCargo = cargos.find(c => hierarquia[c] === nivelAtual - 1);

  await userRef.update({ cargo: novoCargo });
  alert(`${usuario} rebaixado para ${novoCargo}.`);
  mostrarUsuarios();
}

// Remover usuário
async function removerUsuario(usuario) {
  if (!confirm(`Deseja realmente remover o usuário ${usuario}?`)) return;

  await db.collection('usuarios').doc(usuario).delete();
  alert(`${usuario} removido.`);
  mostrarUsuarios();
}

// Mostrar formulário para registrar novo membro
function mostrarFormRegisterMember() {
  esconderTodos();
  mostrar('form-register-member');
  clearMessages();
  document.getElementById('input-new-username').value = '';
  document.getElementById('input-new-password').value = '';
}

// Registrar novo membro no Firestore
async function registrarMembro() {
  clearMessages();
  const novoUser = document.getElementById('input-new-username').value.trim();
  const novaSenha = document.getElementById('input-new-password').value.trim();

  if (!novoUser || !novaSenha) {
    const msg = document.getElementById('msg-register-member');
    msg.textContent = "Preencha usuário e senha.";
    msg.classList.remove('hidden');
    return;
  }

  try {
    const userDoc = await db.collection('usuarios').doc(novoUser).get();
    if (userDoc.exists) {
      throw new Error('Usuário já existe.');
    }

    await db.collection('usuarios').doc(novoUser).set({
      usuario: novoUser,
      senha: novaSenha,
      cargo: 'Agente' // cargo padrão
    });

    const msg = document.getElementById('msg-register-member');
    msg.textContent = "Membro registrado com sucesso!";
    msg.classList.remove('hidden');
    msg.classList.remove('error-msg');
    msg.classList.add('success-msg');

    document.getElementById('input-new-username').value = '';
    document.getElementById('input-new-password').value = '';
  } catch (error) {
    const msg = document.getElementById('msg-register-member');
    msg.textContent = error.message;
    msg.classList.remove('hidden');
  }
}

// Event listeners para botões

document.getElementById('btn-open-boletim').addEventListener('click', mostrarFormBoletim);
document.getElementById('btn-cancel-boletim').addEventListener('click', mostrarMenuPrincipal);
document.getElementById('btn-submit-boletim').addEventListener('click', enviarBoletim);

document.getElementById('btn-open-portaria').addEventListener('click', mostrarPortarias);
document.getElementById('btn-back-portarias').addEventListener('click', mostrarMenuPrincipal);

document.getElementById('btn-open-login').addEventListener('click', mostrarFormLogin);
document.getElementById('btn-cancel-login').addEventListener('click', mostrarMenuPrincipal);
document.getElementById('btn-submit-login').addEventListener('click', login);

document.getElementById('btn-logout').addEventListener('click', logout);

document.getElementById('btn-view-boletins').addEventListener('click', mostrarBoletins);
document.getElementById('btn-back-boletins').addEventListener('click', mostrarAreaLogado);

document.getElementById('btn-admin').addEventListener('click', mostrarUsuarios);
document.getElementById('btn-back-usuarios').addEventListener('click', mostrarAreaLogado);

document.getElementById('btn-register-member').addEventListener('click', mostrarFormRegisterMember);
document.getElementById('btn-cancel-register-member').addEventListener('click', mostrarAreaLogado);
document.getElementById('btn-submit-register-member').addEventListener('click', registrarMembro);

// Inicialização do app
mostrarMenuPrincipal();

  </script>
</body>
</html>
