<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Polícia Federal do Complexo RP</title>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    margin: 2rem;
  }
  button {
    padding: 10px 18px;
    margin: 0 5px 10px 5px;
    cursor: pointer;
    border: none;
    border-radius: 4px;
    color: white;
    font-weight: bold;
  }
  button.blue {
    background-color: #3399ff; /* azul claro */
  }
  button.darkblue {
    background-color: #003366; /* azul escuro */
  }
  button.red {
    background-color: #cc3300;
  }
  input, textarea {
    padding: 8px;
    margin: 8px 0;
    width: 80%;
    max-width: 400px;
  }
  .hidden {
    display: none;
  }
  #boletins-list {
    max-width: 600px;
    margin: 1rem auto;
    text-align: left;
  }
  #boletins-list div {
    border-bottom: 1px solid #ccc;
    padding: 6px 0;
    position: relative;
  }
  .btn-small {
    font-size: 0.8rem;
    padding: 4px 8px;
    margin-left: 8px;
  }
  #admin-list {
    max-width: 600px;
    margin: 1rem auto;
    text-align: left;
  }
  #admin-list div {
    border-bottom: 1px solid #999;
    padding: 8px 0;
  }
  #admin-list button {
    margin-left: 6px;
  }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>

<h1 id="welcome-msg">Bem vindo ao site da Polícia Federal do Complexo RP</h1>

<div id="main-buttons">
  <button id="btn-boletim" class="darkblue">Boletim de Ocorrência</button>
  <button id="btn-portaria" class="darkblue" disabled>Portarias</button>
  <button id="btn-logar" class="darkblue">Logar</button>
</div>

<!-- Formulário boletim -->
<div id="boletim-form" class="hidden">
  <input type="text" id="nome-denuncia" placeholder="Nome de quem denuncia" /><br />
  <input type="text" id="nome-acusado" placeholder="Nome do acusado" /><br />
  <textarea id="descricao" placeholder="Descrição"></textarea><br />
  <button class="blue" id="btn-enviar-boletim">Enviar</button>
  <button class="blue" id="btn-voltar-boletim">Voltar</button>
</div>

<!-- Formulário login -->
<div id="login-form" class="hidden">
  <input type="text" id="input-usuario" placeholder="Usuário" /><br />
  <input type="password" id="input-senha" placeholder="Senha" /><br />
  <button class="blue" id="btn-entrar">Entrar</button>
  <button class="blue" id="btn-voltar-login">Voltar</button>
  <p id="login-error" style="color:red;display:none;">Usuário ou senha incorretos ou exonerado.</p>
</div>

<!-- Após login -->
<div id="logado-area" class="hidden">
  <h2 id="msg-logado"></h2>
  <button id="btn-ver-boletins" class="blue">Ver Boletins</button>
  <button id="btn-administracao" class="blue hidden">Administração</button>
  <button id="btn-sair" class="blue">Sair</button>
  <div id="boletins-list" class="hidden"></div>
</div>

<!-- Área Administração -->
<div id="admin-area" class="hidden">
  <h2>Administração de Usuários</h2>
  <button class="blue" id="btn-fechar-admin">Fechar</button>
  <div id="admin-list"></div>
</div>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBuaVeRTLVxpAyboRiWS6E4KYHWlYZgMEw",
    authDomain: "pfcpx-c0b9b.firebaseapp.com",
    projectId: "pfcpx-c0b9b",
    storageBucket: "pfcpx-c0b9b.firebasestorage.app",
    messagingSenderId: "322312831509",
    appId: "1:322312831509:web:e5fe68609d34db6345c41c",
    measurementId: "G-24QF5E8Q5E"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Elements
  const welcomeMsg = document.getElementById('welcome-msg');
  const mainButtons = document.getElementById('main-buttons');
  const btnBoletim = document.getElementById('btn-boletim');
  const btnPortaria = document.getElementById('btn-portaria');
  const btnLogar = document.getElementById('btn-logar');

  const boletimForm = document.getElementById('boletim-form');
  const nomeDenuncia = document.getElementById('nome-denuncia');
  const nomeAcusado = document.getElementById('nome-acusado');
  const descricao = document.getElementById('descricao');
  const btnEnviarBoletim = document.getElementById('btn-enviar-boletim');
  const btnVoltarBoletim = document.getElementById('btn-voltar-boletim');

  const loginForm = document.getElementById('login-form');
  const inputUsuario = document.getElementById('input-usuario');
  const inputSenha = document.getElementById('input-senha');
  const btnEntrar = document.getElementById('btn-entrar');
  const btnVoltarLogin = document.getElementById('btn-voltar-login');
  const loginError = document.getElementById('login-error');

  const logadoArea = document.getElementById('logado-area');
  const msgLogado = document.getElementById('msg-logado');
  const btnVerBoletins = document.getElementById('btn-ver-boletins');
  const btnAdministracao = document.getElementById('btn-administracao');
  const btnSair = document.getElementById('btn-sair');
  const boletinsList = document.getElementById('boletins-list');

  const adminArea = document.getElementById('admin-area');
  const adminList = document.getElementById('admin-list');
  const btnFecharAdmin = document.getElementById('btn-fechar-admin');

  // Estados
  let usuarioLogado = null; // objeto { id, usuario, cargo, senha }
  const cargosHierarquia = ['Agente', 'Perito', 'Escrivão', 'Delegado', 'Diretor Geral'];

  // Mostrar e esconder telas
  function mostrarMain() {
    welcomeMsg.textContent = "Bem vindo ao site da Polícia Federal do Complexo RP";
    mainButtons.style.display = 'block';
    boletimForm.classList.add('hidden');
    loginForm.classList.add('hidden');
    logadoArea.classList.add('hidden');
    adminArea.classList.add('hidden');
    loginError.style.display = 'none';
  }
  function mostrarBoletimForm() {
    mainButtons.style.display = 'none';
    boletimForm.classList.remove('hidden');
    nomeDenuncia.value = '';
    nomeAcusado.value = '';
    descricao.value = '';
  }
  function mostrarLoginForm() {
    mainButtons.style.display = 'none';
    loginForm.classList.remove('hidden');
    inputUsuario.value = '';
    inputSenha.value = '';
    loginError.style.display = 'none';
  }
  function mostrarLogadoArea() {
    welcomeMsg.textContent = '';
    mainButtons.style.display = 'none';
    boletimForm.classList.add('hidden');
    loginForm.classList.add('hidden');
    logadoArea.classList.remove('hidden');
    adminArea.classList.add('hidden');
    msgLogado.textContent = `Bem vindo, senhor ${usuarioLogado.usuario}. Cargo: ${usuarioLogado.cargo}`;
    boletinsList.classList.add('hidden');

    // Mostrar botão Administração só para Delegado ou Diretor Geral
    if (cargosHierarquia.indexOf(usuarioLogado.cargo) >= cargosHierarquia.indexOf('Delegado')) {
      btnAdministracao.classList.remove('hidden');
    } else {
      btnAdministracao.classList.add('hidden');
    }
  }
  function mostrarAdminArea() {
    adminArea.classList.remove('hidden');
    logadoArea.classList.add('hidden');
    mainButtons.style.display = 'none';
    boletimForm.classList.add('hidden');
    loginForm.classList.add('hidden');
    boletinsList.classList.add('hidden');
    adminList.innerHTML = '<p>Carregando usuários...</p>';

    // Busca todos os usuários
    db.collection('usuarios').get()
      .then(snapshot => {
        if (snapshot.empty) {
          adminList.innerHTML = '<p>Nenhum usuário encontrado.</p>';
          return;
        }
        adminList.innerHTML = '';
        snapshot.forEach(doc => {
          const user = { id: doc.id, ...doc.data() };
          const userCargoIndex = cargosHierarquia.indexOf(user.cargo);
          const logadoCargoIndex = cargosHierarquia.indexOf(usuarioLogado.cargo);

          // Definir se os botões devem aparecer (não pode mexer em si mesmo)
          const podePromover = userCargoIndex < logadoCargoIndex && user.id !== usuarioLogado.id;
          const podeRebaixar = userCargoIndex > 0 && userCargoIndex > logadoCargoIndex && user.id !== usuarioLogado.id;
          const podeExonerar = userCargoIndex < logadoCargoIndex && user.id !== usuarioLogado.id;

          // Botões só aparecem se o logado for delegado ou diretor geral e cargo do usuário for inferior
          // Regras: não pode promover/rebaixar/exonerar superior ou igual
          // Também não pode mexer em si mesmo
          adminList.innerHTML += `
            <div>
              <strong>Usuário:</strong> ${user.usuario} <br/>
              <strong>Senha:</strong> ${user.senha} <br/>
              <strong>Cargo:</strong> ${user.cargo}
              ${podePromover ? `<button class="btn-small blue" onclick="promoverUsuario('${user.id}', '${user.cargo}')">Promover</button>` : ''}
              ${podeRebaixar ? `<button class="btn-small blue" onclick="rebaixarUsuario('${user.id}', '${user.cargo}')">Rebaixar</button>` : ''}
              ${podeExonerar ? `<button class="btn-small red" onclick="exonerarUsuario('${user.id}')">Exonerar</button>` : ''}
            </div>
          `;
        });
      })
      .catch(error => {
        adminList.innerHTML = `<p>Erro ao carregar usuários: ${error.message}</p>`;
      });
  }

  // Funções ação administração
  window.promoverUsuario = function(id, cargoAtual) {
    const idx = cargosHierarquia.indexOf(cargoAtual);
    if (idx < 0 || idx >= cargosHierarquia.length - 1) {
      alert('Não pode promover mais.');
      return;
    }
    const novoCargo = cargosHierarquia[idx + 1];
    db.collection('usuarios').doc(id).update({ cargo: novoCargo })
      .then(() => {
        alert('Usuário promovido para ' + novoCargo);
        mostrarAdminArea();
      }).catch(e => alert('Erro ao promover: ' + e.message));
  };
  window.rebaixarUsuario = function(id, cargoAtual) {
    const idx = cargosHierarquia.indexOf(cargoAtual);
    if (idx <= 0) {
      alert('Não pode rebaixar mais.');
      return;
    }
    const novoCargo = cargosHierarquia[idx - 1];
    db.collection('usuarios').doc(id).update({ cargo: novoCargo })
      .then(() => {
        alert('Usuário rebaixado para ' + novoCargo);
        mostrarAdminArea();
      }).catch(e => alert('Erro ao rebaixar: ' + e.message));
  };
  window.exonerarUsuario = function(id) {
    if (!confirm('Confirma exonerar esse usuário? Ele perderá acesso.')) return;
    db.collection('usuarios').doc(id).delete()
      .then(() => {
        alert('Usuário exonerado e removido.');
        mostrarAdminArea();
      }).catch(e => alert('Erro ao exonerar: ' + e.message));
  };

  // Botões principais
  btnBoletim.onclick = () => mostrarBoletimForm();
  btnPortaria.onclick = () => alert('Portarias: Teste 1 e Teste 2');
  btnLogar.onclick = () => mostrarLoginForm();

  btnVoltarBoletim.onclick = () => mostrarMain();
  btnVoltarLogin.onclick = () => mostrarMain();

  btnSair.onclick = () => {
    usuarioLogado = null;
    mostrarMain();
  };

  btnAdministracao.onclick = () => mostrarAdminArea();
  btnFecharAdmin.onclick = () => mostrarLogadoArea();

  // Enviar boletim
  btnEnviarBoletim.onclick = () => {
    const nomeD = nomeDenuncia.value.trim();
    const nomeA = nomeAcusado.value.trim();
    const desc = descricao.value.trim();

    if (!nomeD || !nomeA || !desc) {
      alert('Preencha todos os campos.');
      return;
    }

    db.collection('boletins').add({
      nomeDenuncia: nomeD,
      nomeAcusado: nomeA,
      descricao: desc,
      data: new Date()
    }).then(() => {
      alert('Boletim registrado com sucesso!');
      mostrarMain();
    }).catch((e) => {
      alert('Erro ao registrar boletim: ' + e.message);
    });
  };

  // Login dinâmico
  btnEntrar.onclick = () => {
    const usuario = inputUsuario.value.trim();
    const senha = inputSenha.value.trim();

    if (!usuario || !senha) {
      loginError.style.display = 'block';
      loginError.textContent = 'Preencha usuário e senha.';
      return;
    }

    // Busca no Firestore
    db.collection('usuarios')
      .where('usuario', '==', usuario)
      .where('senha', '==', senha)
      .limit(1)
      .get()
      .then(snapshot => {
        if (snapshot.empty) {
          loginError.style.display = 'block';
          loginError.textContent = 'Usuário ou senha incorretos ou exonerado.';
          return;
        }
        // Encontrou o usuário válido
        snapshot.forEach(doc => {
          usuarioLogado = { id: doc.id, ...doc.data() };
        });
        mostrarLogadoArea();
      })
      .catch(e => {
        loginError.style.display = 'block';
        loginError.textContent = 'Erro ao tentar logar: ' + e.message;
      });
  };

  // Ver boletins
  btnVerBoletins.onclick = () => {
    boletinsList.innerHTML = '<h3>Boletins Registrados:</h3>';
    boletinsList.classList.remove('hidden');

    db.collection('boletins')
      .orderBy('data', 'desc')
      .get()
      .then(querySnapshot => {
        if (querySnapshot.empty) {
          boletinsList.innerHTML += '<p>Nenhum boletim encontrado.</p>';
          return;
        }
        boletinsList.innerHTML = '<h3>Boletins Registrados:</h3>';
        querySnapshot.forEach(doc => {
          const dataObj = doc.data();
          const dataFormatada = new Date(dataObj.data.seconds * 1000).toLocaleString('pt-BR');

          let btnExcluirHTML = '';

          // Delegado e Diretor Geral podem excluir boletins
          const cargoIndex = cargosHierarquia.indexOf(usuarioLogado.cargo);
          const delegadoIndex = cargosHierarquia.indexOf('Delegado');
          if (cargoIndex >= delegadoIndex) {
            btnExcluirHTML = `<button class="btn-small red" onclick="excluirBoletim('${doc.id}')">Excluir</button>`;
          }

          boletinsList.innerHTML += `
            <div>
              <strong>Denunciante:</strong> ${dataObj.nomeDenuncia} <br />
              <strong>Acusado:</strong> ${dataObj.nomeAcusado} <br />
              <strong>Descrição:</strong> ${dataObj.descricao} <br />
              <small><em>Data: ${dataFormatada}</em></small>
              ${btnExcluirHTML}
            </div>
          `;
        });
      })
      .catch(e => {
        boletinsList.innerHTML = `<p>Erro ao buscar boletins: ${e.message}</p>`;
      });
  };

  window.excluirBoletim = function(id) {
    if (!confirm('Confirma exclusão deste boletim?')) return;
    db.collection('boletins').doc(id).delete()
      .then(() => {
        alert('Boletim excluído.');
        btnVerBoletins.click(); // Atualiza lista
      }).catch(e => alert('Erro ao excluir boletim: ' + e.message));
  };

  // Inicializa
  mostrarMain();

</script>

</body>
</html>
